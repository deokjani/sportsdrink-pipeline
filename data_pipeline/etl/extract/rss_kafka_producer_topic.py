import feedparser
from kafka import KafkaProducer
import json

# Kafka ì„¤ì •
KAFKA_BROKER = "localhost:29092"
KAFKA_TOPIC = "news_rss_topic"

# âœ… ìµœì¢… ê²€ì¦ëœ RSS í”¼ë“œ ì£¼ì†Œ (ì •ìƒ ì‘ë‹µ ê¸°ì¤€)
RSS_FEEDS = [
    "https://www.chosun.com/arc/outboundfeeds/rss/category/economy/?outputType=xml",
    "https://www.mk.co.kr/rss/30000001/",
    "https://www.yna.co.kr/rss/economy.xml",
    "https://www.yna.co.kr/rss/industry.xml",
    "http://rss.donga.com/economy.xml",
    "http://rss.segye.com/segye_economy.xml"
]


# âœ… ë¸Œëœë“œ í‚¤ì›Œë“œ (ì •ì‹ëª…, ë„ì–´ì“°ê¸° í¬í•¨, ì˜ë¬¸ í˜¼ìš© ê°€ëŠ¥)
BRANDS = [
    "í¬ì¹´ë¦¬", "í¬ì¹´ë¦¬ìŠ¤ì›¨íŠ¸", "Pocari Sweat",
    "ê²Œí† ë ˆì´", "Gatorade",
    "íŒŒì›Œì—ì´ë“œ", "Powerade",
    "í† ë ˆíƒ€", "Toreta",
    "ë§í‹°", "Lingt",
    "ì´ì˜¨ìŒë£Œ", "ì´ì˜¨ ìŒë£Œ", "ìŠ¤í¬ì¸ ìŒë£Œ", "ìŠ¤í¬ì¸  ìŒë£Œ", "ê¸°ëŠ¥ì„± ìŒë£Œ"
]

# âœ… ì‹œì¥ íŠ¸ë Œë“œ / ì†Œë¹„ ë¶„ì„ í‚¤ì›Œë“œ
FILTER_KEYWORDS = [
    # ğŸ“Š ì‹œì¥ ì ìœ ìœ¨ / ê²½ìŸ êµ¬ë„
    "ì‹œì¥ ì ìœ ìœ¨", "ë¸Œëœë“œ ì ìœ ìœ¨", "ì—…ê³„ ì ìœ ìœ¨",
    "íŒë§¤ëŸ‰ ì¦ê°€", "íŒë§¤ëŸ‰ ê°ì†Œ", "íŒë§¤ ì¶”ì´", "ë§¤ì¶œ ì¶”ì´",
    "ì„±ì¥ë¥ ", "ì „ë…„ ëŒ€ë¹„ ì„±ì¥", "ì„±ì¥ì„¸", "ì‹¤ì  ì¦ê°€",
    "ì†Œë¹„ íŠ¸ë Œë“œ", "ì†Œë¹„ íŒ¨í„´", "ìŒë£Œ ì†Œë¹„ ë¶„ì„", "ì†Œë¹„ ë³€í™”",
    "ë¸Œëœë“œ ê²½ìŸ", "ê²½ìŸ ì‹¬í™”", "ê²½ìŸ ë¸Œëœë“œ", "ìŒë£Œì—…ê³„ ê²½ìŸ",
    "ì‹œì¥ ì§„ì…", "ì‹œì¥ í™•ëŒ€", "ì‹œì¥ ë™í–¥", "ì—…ê³„ ë™í–¥",
    "ì‹œì¥ì¡°ì‚¬", "íŠ¸ë Œë“œ ë¦¬í¬íŠ¸", "ì¹´í…Œê³ ë¦¬ ë¦¬ë”", "ë¸Œëœë“œ íŒŒì›Œ",

    # ğŸ“¢ ë§ˆì¼€íŒ… / ì œí’ˆ ì „ëµ
    "ë§ˆì¼€íŒ… ì „ëµ", "ë¸Œëœë“œ ë§ˆì¼€íŒ…", "ë””ì§€í„¸ ë§ˆì¼€íŒ…", "SNS ë§ˆì¼€íŒ…",
    "ì‹ ì œí’ˆ ì¶œì‹œ", "ìŒë£Œ ì‹ ì œí’ˆ", "íŒ¨í‚¤ì§€ ë¦¬ë‰´ì–¼", "ì œí’ˆ ë¦¬ë‰´ì–¼",
    "ì½œë¼ë³´ ì œí’ˆ", "ì´ìƒ‰ ì½œë¼ë³´", "í•œì •íŒ ìŒë£Œ", "ì´ë²¤íŠ¸ í•œì •",
    "ê±´ê°• ê°•ì¡°", "í”„ë¦¬ë¯¸ì—„ ì œí’ˆ", "í”„ë¦¬ë¯¸ì—„ ìŒë£Œ", "ì»¨ì…‰ ìŒë£Œ",
    "ê¸°ëŠ¥ì„± ìŒë£Œ", "íƒ€ê²Ÿ ë§ˆì¼€íŒ…", "ê´‘ê³  ìº í˜ì¸", "ë¸Œëœë“œ ëª¨ë¸",
    "ë¦¬ë¸Œëœë”©", "ì œí’ˆ ì´ë¯¸ì§€ ë³€í™”", "ë¸Œëœë“œ ì´ë¯¸ì§€ ê°•í™”",

    # ğŸ›’ ìœ í†µ / ì±„ë„ / ì˜¤í”„ë¼ì¸
    "ìœ í†µì±„ë„", "ì˜¨ë¼ì¸ íŒë§¤", "ì´ì»¤ë¨¸ìŠ¤", "ì˜¨ë¼ì¸ í”Œë«í¼",
    "í¸ì˜ì  ìŒë£Œ", "í¸ì˜ì  ë§¤ì¶œ", "CU ìŒë£Œ", "GS25 ìŒë£Œ",
    "ì˜¤í”ˆë§ˆì¼“", "ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´", "SSGë‹·ì»´", "ë§ˆì¼“ì»¬ë¦¬",
    "ëŒ€í˜•ë§ˆíŠ¸", "ì´ë§ˆíŠ¸ ìŒë£Œ", "í™ˆí”ŒëŸ¬ìŠ¤", "ë¡¯ë°ë§ˆíŠ¸",
    "H&B ìŠ¤í† ì–´", "ì˜¬ë¦¬ë¸Œì˜ ìŒë£Œ", "ë„ë¼ë¸”ë¼", "ë¡­ìŠ¤",
    "í—¬ìŠ¤ìŠ¤í† ì–´", "ì˜¤í”„ë¼ì¸ ì±„ë„", "ì „êµ­ ìœ í†µë§", "ë¦¬í…Œì¼ ì „ëµ",

    # ğŸ§ƒ ê±´ê°•/í—¬ìŠ¤/ê¸°ëŠ¥ì„± ê´€ë ¨
    "ê±´ê°• ìŒë£Œ", "ìŠ¤í¬ì¸  ìŒë£Œ", "í—¬ìŠ¤ì¼€ì–´ ìŒë£Œ", "ë‹¤ì´ì–´íŠ¸ ìŒë£Œ",
    "ìš´ë™ í›„ ìŒë£Œ", "ìš´ë™ë³´ì¶© ìŒë£Œ", "í”¼ë¡œíšŒë³µ ìŒë£Œ",
    "ìˆ˜ë¶„ ë³´ì¶©", "ìˆ˜ë¶„ ë³´ì¶©ì œ", "ì—ë„ˆì§€ ë³´ì¶©", "í”¼ë¡œ íšŒë³µ",
    "ì´ì˜¨ ë°¸ëŸ°ìŠ¤", "ì „í•´ì§ˆ ë³´ì¶©", "ë¹„íƒ€ë¯¼ ìŒë£Œ", "ì˜ì–‘ ê°•í™”",
    "ê¸°ëŠ¥ì„± í‘œì‹œ ì‹í’ˆ", "ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ", "ë©´ì—­ë ¥ ê°•í™”", "ì²´ë ¥ ë³´ì¶©",

    # ğŸ‘¥ ì†Œë¹„ì ì„±í–¥ / íŠ¸ë Œë“œ
    "MZì„¸ëŒ€ ì†Œë¹„", "2030 ì†Œë¹„ íŠ¸ë Œë“œ", "Zì„¸ëŒ€ ìŒë£Œ",
    "ì†Œë¹„ì ì„ í˜¸ë„", "ì†Œë¹„ì í‰ê°€", "ê³ ê° ë°˜ì‘",
    "ì›°ë¹™ íŠ¸ë Œë“œ", "ì¹œí™˜ê²½ íŠ¸ë Œë“œ", "ì œë¡œì¹¼ë¡œë¦¬ ìŒë£Œ", "ì œë¡œ ìŒë£Œ",
    "ì €ë‹¹ ìŒë£Œ", "ë…¸ìŠˆê°€", "ë¬´ì¹´í˜ì¸", "ë¹„ê±´ ìŒë£Œ", "ì‹ë¬¼ì„± ìŒë£Œ",
    "ë¼ì´í”„ìŠ¤íƒ€ì¼ ë³€í™”", "ê±´ê°• ì¤‘ì‹œ ì†Œë¹„", "ì†Œë¹„ì‹¬ë¦¬", "ìŒë£Œ ì„ íƒ ê¸°ì¤€"
]

# âœ… ì „ì²´ í‚¤ì›Œë“œ ì¤‘ë³µ ì œê±°
ALL_BRANDS = set(BRANDS)
ALL_MARKETS = set(FILTER_KEYWORDS)

# Kafka Producer ìƒì„±
producer = KafkaProducer(
    bootstrap_servers=KAFKA_BROKER,
    value_serializer=lambda v: json.dumps(v, ensure_ascii=False).encode("utf-8")
)

# í•„í„°ë§ í•¨ìˆ˜: ë¸Œëœë“œ + ì‹œì¥ í‚¤ì›Œë“œ ëª¨ë‘ í¬í•¨ëœ ê²½ìš°ë§Œ ìˆ˜ì§‘
def is_relevant_article(content: str) -> bool:
    return any(b in content for b in ALL_BRANDS) or any(k in content for k in ALL_MARKETS)

# RSS ìˆ˜ì§‘ í•¨ìˆ˜
def fetch_and_send_rss():
    for feed_url in RSS_FEEDS:
        parsed_feed = feedparser.parse(feed_url)
        status = parsed_feed.get("status", "unknown")
        print(f"ğŸ“¥ {feed_url} â†’ HTTP {status}, {len(parsed_feed.entries)}ê°œ ê¸°ì‚¬ ìˆ˜ì‹ ë¨")

        for entry in parsed_feed.entries:
            title = entry.get("title", "")
            summary = entry.get("summary", "")
            content = f"{title} {summary}"

            if is_relevant_article(content):
                news = {
                    "source": feed_url,
                    "title": title,
                    "link": entry.get("link"),
                    "summary": summary,
                    "published": entry.get("published", "")
                }

                producer.send(KAFKA_TOPIC, value=news)
                print(f"âœ… ì „ì†¡ ì™„ë£Œ: {title}")
            else:
                print(f"â›”ï¸ í•„í„° ë¶ˆì¼ì¹˜ (ê±´ë„ˆëœ€): {title}")

if __name__ == "__main__":
    fetch_and_send_rss()
    producer.close()
